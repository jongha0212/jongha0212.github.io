---
title: "Tanzu Kubernetes Grid 1.5.2"
date: 2022-04-13
categories: [Tanzu]
tags: [Tanzu, TKG, Kubernetes]
description: Tanzu Kubernetes Grid 1.5.2
toc: true
published: false
---

# Tanzu Kubernetes Grid 1.5.2 on vSphere

Caution: VMware recommends not installing or upgrading to TKG v1.5 until a future patch release, due to a bug in the versions of etcd in the versions of Kubernetes used by Tanzu Kubernetes Grid v1.5.0-v1.5.2. See [Known Issues](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/1.5/rn/vmware-tanzu-kubernetes-grid-15-release-notes/index.html#known-issues) in the TKG v1.5 Release Notes.


## 설치 가이드
* vSphere 7.0 & Ubuntu 20.04 기준 작성

### Download and Unpack the Tanzu CLI and kubectl
1. Go to [https://my.vmware.com](https://my.vmware.com) and log in with your My VMware credentials.

1. Visit [the Tanzu Kubernetes Grid downloads page](https://customerconnect.vmware.com/en/downloads/info/slug/infrastructure_operations_management/vmware_tanzu_kubernetes_grid/1_x)

1. In the VMware Tanzu Kubernetes Grid row, click Go to Downloads.

1. In the Select Version drop-down, select 1.5.2.

1. Under Product Downloads, scroll to the section labeled VMware Tanzu CLI 1.5.2 CLI.
  * For Linux, locate VMware Tanzu CLI for Linux and click Download Now.

1. Navigate to the Kubectl 1.22.5 for VMware Tanzu Kubernetes Grid 1.5.2 section of the download page.
  * For Linux, locate kubectl cluster cli v1.22.5 for Linux and click Download Now.

1. (Optional) Verify that your downloaded files are unaltered from the original. VMware provides a SHA-1, a SHA-256, and an MD5 checksum for each download. To obtain these checksums, click Read More under the entry that you want to download. For more information, see Using Cryptographic Hashes.

1. On your system, create a new directory named tanzu. If you previously unpacked artifacts for previous releases to this folder, delete the folder’s existing contents.

1. In the tanzu folder, unpack the Tanzu CLI bundle file for your operating system. To unpack the bundle file, use the extraction tool of your choice. For example, the tar -xvf command.
  * For Linux, unpack tanzu-cli-bundle-linux-amd64.tar.
  * After you unpack the bundle file, in your tanzu folder, you will see a cli folder with multiple subfolders and files.
1. Unpack the kubectl binary for your operating system:
  * For Linux, unpack kubectl-linux-v1.22.5+vmware.1.gz.  

### Install th Tanzu and Other Tools

1. **tanzu/cli** 이동
1. 시스템에서 CLI 사용
  * binary를 **/usr/local/bin** 위치에 설치

        ```console        
        $ sudo install core/v1.3.1/tanzu-core-linux_amd64 /usr/local/bin/tanzu
        ```
        * e.g.

            ```console
            [ubuntu@tkg-jumpbox /app/tkg/cli]$
             $ sudo install core/v0.11.2/tanzu-core-linux_amd64 /usr/local/bin/tanzu
            [sudo] ubuntu의 암호:
            [ubuntu@tkg-jumpbox /app/tkg/cli]$
            ```
1. initialize the Tanzu CLI

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ tanzu init
    Checking for required plugins...
    All required plugins are already installed and up-to-date
    ✔  successfully initialized CLI
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```
1. Tanzu Kubernetes Grid v1.5.2는 Tanzu Framework v0.11.2를 사용

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ tanzu version
    version: v0.11.2
    buildDate: 2022-03-17
    sha: 9f16f375
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

### Install the Tanzu CLI Plugin

Tanzu Kubernetes 클러스터 관리 및 기능 작업과 관련된 CLI 플러그인을 설치

1. 기존 플러그인 제거

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ tanzu plugin clean
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```
1. cli 디렉토리로 이동

1. tanzu 디렉토리에서 다음 명령을 실행하여 모든 플러그인을 설치

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ tanzu plugin sync
    Checking for required plugins...
    Installing plugin 'login:v0.11.2'
    Installing plugin 'management-cluster:v0.11.2'
    Installing plugin 'package:v0.11.2'
    Installing plugin 'pinniped-auth:v0.11.2'
    Installing plugin 'secret:v0.11.2'
    Successfully installed all required plugins
    ✔  Done
    [ubuntu@tkg-jumpbox /app/tkg/cli]$    
    ```
1. 설치된 플로그인 확인

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ tanzu plugin list
      NAME                DESCRIPTION                                                        SCOPE       DISCOVERY      VERSION  STATUS     
      login               Login to the platform                                              Standalone  default        v0.11.2  installed  
      management-cluster  Kubernetes management-cluster operations                           Standalone  default        v0.11.2  installed  
      package             Tanzu package management                                           Standalone  default        v0.11.2  installed  
      pinniped-auth       Pinniped authentication operations (usually not directly invoked)  Standalone  default        v0.11.2  installed  
      secret              Tanzu secret management                                            Standalone  default        v0.11.2  installed  
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

### Install kubectl

1. 위의 **kubectl-linux-v1.22.5+vmware.1.gz** 압축 해제한 디렉토리 이동

1. binary를 **/usr/local/bin** 위치에 설치

    ```console
    [ubuntu@tkg-jumpbox /app/tkg]$
     $ chmod ugo+x kubectl-linux-v1.22.5+vmware.1
    [ubuntu@tkg-jumpbox /app/tkg]$
     $ sudo install kubectl-linux-v1.22.5+vmware.1 /usr/local/bin/kubectl
    [ubuntu@tkg-jumpbox /app/tkg]$
     $ kubectl version
    Client Version: version.Info{Major:"1", Minor:"22", GitVersion:"v1.22.5+vmware.1",     GitCommit:"8ef4fc5015d7c770c6ac367fcb1d13ed4e99d974", GitTreeState:"clean", BuildDate:"2021-12-17T23:12:22Z",     GoVersion:"go1.16.12", Compiler:"gc", Platform:"linux/amd64"}
    Server Version: version.Info{Major:"1", Minor:"20", GitVersion:"v1.20.5+vmware.1",     GitCommit:"f4553304874c3b89584280a5ac1b005d57c725a8", GitTreeState:"clean", BuildDate:"2021-03-22T16:56:50Z",     GoVersion:"go1.15.8", Compiler:"gc", Platform:"linux/amd64"}
    WARNING: version difference between client (1.22) and server (1.20) exceeds the supported minor version skew of +/-1
    [ubuntu@tkg-jumpbox /app/tkg]$
    ```

### Install th Carvel Tools

Carvel은 애플리케이션 구축, 구성 및 Kubernetes 배포를 지원하는 안정적인 단일 목적의 구성 가능한 도구 세트를 제공.    
Tanzu Kubernetes Grid는 Carvel 오픈 소스 프로젝트의 다음 도구를 사용.

* [ytt](https://carvel.dev/ytt/) - a command-line tool for templating and patching YAML files. You can also use ytt to collect fragments and piles of YAML into modular chunks for easy re-use.
* [kapp](https://carvel.dev/kapp/) - the applications deployment CLI for Kubernetes. It allows you to install, upgrade, and delete multiple Kubernetes resources as one application.
* [kbld](https://carvel.dev/kbld/) - an image-building and resolution tool.
* [imgpkg](https://carvel.dev/imgpkg/) - a tool that enables Kubernetes to store configurations and the associated container images as OCI images, and to transfer these images.

#### Install ytt

1. 압축 해제 및 **/usr/local/bin**으로 복사

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ gunzip ytt-linux-amd64-v0.35.1+vmware.1.gz
     $ chmod ugo+x ytt-linux-amd64-v0.35.1+vmware.1
     $ sudo mv ./ytt-linux-amd64-v0.35.1+vmware.1 /usr/local/bin/ytt
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

#### Install kapp

1. 압축 해제 및 **/usr/local/bin**으로 복사

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ gunzip kapp-linux-amd64-v0.42.0+vmware.1.gz
     $ chmod ugo+x kapp-linux-amd64-v0.42.0+vmware.1
     $ sudo mv ./kapp-linux-amd64-v0.42.0+vmware.1 /usr/local/bin/kapp
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

#### Install kbld

1. 압축 해제 및 **/usr/local/bin**으로 복사

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ gunzip kbld-linux-amd64-v0.31.0+vmware.1.gz
     $ chmod ugo+x kbld-linux-amd64-v0.31.0+vmware.1
     $ sudo mv ./kbld-linux-amd64-v0.31.0+vmware.1 /usr/local/bin/kbld
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

#### Install imgpkg

1. 압축 해제 및 **/usr/local/bin**으로 복사

    ```console
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
     $ gunzip imgpkg-linux-amd64-v0.18.0+vmware.1.gz
     $ chmod ugo+x imgpkg-linux-amd64-v0.18.0+vmware.1
     $ sudo mv ./imgpkg-linux-amd64-v0.18.0+vmware.1 /usr/local/bin/imgpkg
    [ubuntu@tkg-jumpbox /app/tkg/cli]$
    ```

---

## Prepare to Deploy Management Clusters to vSphere

* tanzu cli, docker, kubectl이 설치되어 있는 jumpbox.

* network
    * vSphere에 배포하는 모든 클러스터에는 Kube-Vip이 API 서버 endpoint에 사용할 고정 IP 필요.
    * management-cluster를 배포할때 이 고정 IP를 사용.
    * vip는 dhcp의 range가 아닌, dhcp range와 동일한 subnet에 있어야함.

* image template
    * 클러스터를 vSphere에 배포하기 전에 클러스터 노드가 실행되는 OS 및 Kubernetes 버전이 포함된 기본 이미지 템플릿을 vSphere로 가져와야함.
    * OVA를 vSphere로 가져온 후 결과 VM을 VM 템플릿으로 변환.
    * management cluster : OVA에는 Tanzu Kubernetes Grid v1.5의 기본 버전인 Kubernetes v1.22.5가 있어야함.
        * Ubuntu v20.04 Kubernetes v1.22.5 OVA
        * Photon v3 Kubernetes v1.22.5 OVA
    * workload cluster : OVA는 Tanzu Kubernetes 릴리스에 패키지된 형태로 지원되는 OS 및 Kubernetes 버전이면됨. 다양한 kubernetes 버전으로 Tanzu Kubernetes 클러스터를 배포할 수 있음.
    * image template 추가 가이드는 skip.

* create an SSH key pair
    * bootstrap machine에서 ssh-keygen command 활용

    ```console
    $ ssh-keygen -t rsa -b 4096 -C "jongha0212@gmail.com"
    ```
    * SSH 에이전트에 개인 키를 추가

    ```console
    $ ssh-add ~/.ssh/id_rsa
    ```
    * 에러 발생 시 : Could not open a connection to your authentication agent.

        ```console
        root@tkg-jumpbox:~/.ssh# ssh-add ~/.ssh/id_rsa
        Could not open a connection to your authentication agent.
        root@tkg-jumpbox:~/.ssh# eval $(ssh-agent)
        Agent pid 180371
        root@tkg-jumpbox:~/.ssh# ssh-add ~/.ssh/id_rsa
        Identity added: /root/.ssh/id_rsa (jongha0212@gmail.com)
        root@tkg-jumpbox:~/.ssh#
        ```
